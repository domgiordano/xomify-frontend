<div class="page-container">
  <div class="queue-builder-content">
    <!-- Page Header -->
    <header class="page-header">
      <button class="back-btn" routerLink="/my-profile">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
        Back to Profile
      </button>
      <h1 class="page-title">Queue Builder</h1>
      <p class="page-subtitle">Search, build, and save your perfect playlist</p>
    </header>

    <div class="builder-layout">
      <!-- Left: Search Panel -->
      <div class="search-panel">
        <div class="panel-header">
          <h2>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"/>
              <path d="m21 21-4.35-4.35"/>
            </svg>
            Search Tracks
          </h2>
        </div>

        <div class="search-box">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/>
            <path d="m21 21-4.35-4.35"/>
          </svg>
          <input 
            type="text" 
            placeholder="Search for songs, artists, albums..." 
            [(ngModel)]="searchQuery"
            (input)="onSearchInput()"
          />
          <button class="clear-btn" *ngIf="searchQuery" (click)="clearSearch()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        </div>

        <!-- Search Results -->
        <div class="search-results">
          <div class="loading-indicator" *ngIf="isSearching">
            <div class="spinner"></div>
            <span>Searching...</span>
          </div>

          <div class="results-list" *ngIf="!isSearching && searchResults.length > 0">
            <div 
              class="result-item" 
              *ngFor="let track of searchResults"
              [class.in-queue]="isInQueue(track.id)"
            >
              <div class="track-image">
                <img [src]="track.album.images?.[2]?.url || track.album.images?.[0]?.url" [alt]="track.name"/>
                <button class="preview-btn" *ngIf="track.preview_url" (click)="playPreview(track)">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8 5v14l11-7z"/>
                  </svg>
                </button>
              </div>
              
              <div class="track-info">
                <span class="track-name">{{ track.name }}</span>
                <span class="track-artist" (click)="goToArtist(track.artists[0]?.id)">
                  {{ getArtistNames(track) }}
                </span>
              </div>
              
              <span class="track-duration">{{ formatDuration(track.duration_ms) }}</span>
              
              <button 
                class="add-btn" 
                (click)="addToQueue(track)"
                [disabled]="isInQueue(track.id)"
              >
                <svg *ngIf="!isInQueue(track.id)" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19"/>
                  <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                <svg *ngIf="isInQueue(track.id)" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                </svg>
              </button>
            </div>
          </div>

          <div class="empty-search" *ngIf="!isSearching && searchQuery && searchResults.length === 0">
            <p>No tracks found for "{{ searchQuery }}"</p>
          </div>

          <div class="search-hint" *ngIf="!searchQuery && searchResults.length === 0">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="11" cy="11" r="8"/>
              <path d="m21 21-4.35-4.35"/>
            </svg>
            <p>Search for tracks to add to your queue</p>
          </div>
        </div>
      </div>

      <!-- Right: Queue Panel -->
      <div class="queue-panel">
        <div class="panel-header">
          <h2>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="8" y1="6" x2="21" y2="6"/>
              <line x1="8" y1="12" x2="21" y2="12"/>
              <line x1="8" y1="18" x2="21" y2="18"/>
              <line x1="3" y1="6" x2="3.01" y2="6"/>
              <line x1="3" y1="12" x2="3.01" y2="12"/>
              <line x1="3" y1="18" x2="3.01" y2="18"/>
            </svg>
            Your Queue
            <span class="track-count" *ngIf="queue.length > 0">{{ queue.length }} tracks</span>
          </h2>
          <button class="clear-queue-btn" *ngIf="queue.length > 0" (click)="clearQueue()">
            Clear All
          </button>
        </div>

        <!-- Queue Stats -->
        <div class="queue-stats" *ngIf="queue.length > 0">
          <div class="stat">
            <span class="stat-value">{{ formatTotalDuration() }}</span>
            <span class="stat-label">Duration</span>
          </div>
          <div class="stat">
            <span class="stat-value">{{ uniqueArtists }}</span>
            <span class="stat-label">Artists</span>
          </div>
        </div>

        <!-- Queue List (Drag & Drop) -->
        <div 
          class="queue-list" 
          cdkDropList 
          (cdkDropListDropped)="onDrop($event)"
          *ngIf="queue.length > 0"
        >
          <div 
            class="queue-item" 
            *ngFor="let track of queue; let i = index"
            cdkDrag
          >
            <div class="drag-handle" cdkDragHandle>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <circle cx="9" cy="6" r="1.5"/>
                <circle cx="15" cy="6" r="1.5"/>
                <circle cx="9" cy="12" r="1.5"/>
                <circle cx="15" cy="12" r="1.5"/>
                <circle cx="9" cy="18" r="1.5"/>
                <circle cx="15" cy="18" r="1.5"/>
              </svg>
            </div>
            
            <span class="queue-number">{{ i + 1 }}</span>
            
            <div class="track-image">
              <img [src]="track.album.images?.[2]?.url || track.album.images?.[0]?.url" [alt]="track.name"/>
            </div>
            
            <div class="track-info">
              <span class="track-name">{{ track.name }}</span>
              <span class="track-artist">{{ getArtistNames(track) }}</span>
            </div>
            
            <span class="track-duration">{{ formatDuration(track.duration_ms) }}</span>
            
            <div class="item-actions">
              <button 
                class="move-btn" 
                (click)="moveTrack(i, 'up')" 
                [disabled]="i === 0"
                title="Move up"
              >
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M18 15l-6-6-6 6"/>
                </svg>
              </button>
              <button 
                class="move-btn" 
                (click)="moveTrack(i, 'down')" 
                [disabled]="i === queue.length - 1"
                title="Move down"
              >
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M6 9l6 6 6-6"/>
                </svg>
              </button>
              <button class="remove-btn" (click)="removeFromQueue(i)" title="Remove">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>

            <!-- Drag placeholder -->
            <div class="drag-placeholder" *cdkDragPlaceholder></div>
          </div>
        </div>

        <!-- Empty Queue -->
        <div class="empty-queue" *ngIf="queue.length === 0">
          <div class="empty-icon">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M9 18V5l12-2v13"/>
              <circle cx="6" cy="18" r="3"/>
              <circle cx="18" cy="16" r="3"/>
            </svg>
          </div>
          <h3>Your queue is empty</h3>
          <p>Search and add tracks to build your playlist</p>
        </div>

        <!-- Action Buttons -->
        <div class="queue-actions" *ngIf="queue.length > 0">
          <button class="action-btn primary" (click)="openSaveModal()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
              <polyline points="17 21 17 13 7 13 7 21"/>
              <polyline points="7 3 7 8 15 8"/>
            </svg>
            Save as Playlist
          </button>
          
          <button class="action-btn secondary" (click)="playAllInSpotify()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/>
            </svg>
            Open in Spotify
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Save Playlist Modal -->
  <div class="modal-overlay" *ngIf="showSaveModal" (click)="closeSaveModal()">
    <div class="save-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Save as Playlist</h2>
        <button class="close-btn" (click)="closeSaveModal()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        <div class="form-group">
          <label for="playlistName">Playlist Name</label>
          <input 
            type="text" 
            id="playlistName"
            [(ngModel)]="playlistName"
            placeholder="Enter playlist name"
          />
        </div>

        <div class="form-group">
          <label for="playlistDesc">Description (optional)</label>
          <textarea 
            id="playlistDesc"
            [(ngModel)]="playlistDescription"
            placeholder="Add a description..."
            rows="3"
          ></textarea>
        </div>

        <div class="form-group checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" [(ngModel)]="isPublic"/>
            <span class="checkmark"></span>
            Make playlist public
          </label>
        </div>

        <div class="playlist-preview">
          <span class="preview-count">{{ queue.length }} tracks</span>
          <span class="preview-duration">{{ formatTotalDuration() }}</span>
        </div>
      </div>

      <div class="modal-footer">
        <button class="cancel-btn" (click)="closeSaveModal()">Cancel</button>
        <button 
          class="save-btn" 
          (click)="saveAsPlaylist()"
          [disabled]="isSaving || !playlistName.trim()"
        >
          <span *ngIf="!isSaving">Create Playlist</span>
          <span *ngIf="isSaving">Creating...</span>
        </button>
      </div>
    </div>
  </div>
</div>
