<div class="page-container">
  <!-- Loading State -->
  <div class="loading-container" *ngIf="loading">
    <div class="loader">
      <div class="wave"></div>
      <div class="wave"></div>
      <div class="wave"></div>
      <div class="wave"></div>
      <div class="wave"></div>
    </div>
    <p class="loading-text">Loading group...</p>
  </div>

  <div class="group-content" *ngIf="!loading && group">
    <!-- Back Button -->
    <button class="back-btn" (click)="goBack()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5"/>
        <path d="M12 19l-7-7 7-7"/>
      </svg>
      Back to Groups
    </button>

    <!-- Group Header -->
    <header class="group-header">
      <div class="header-info">
        <h1 class="group-name">{{ group.name }}</h1>
        <p class="group-description" *ngIf="group.description">{{ group.description }}</p>

        <!-- Members -->
        <div class="members-row">
          <div class="member-avatars">
            <div
              class="member-avatar"
              *ngFor="let member of group.members.slice(0, 5)"
              [title]="member.displayName || member.email"
            >
              <img [src]="member.avatar || getDefaultAvatar()" [alt]="member.displayName || member.email" />
            </div>
            <div class="more-members" *ngIf="group.members.length > 5">
              +{{ group.members.length - 5 }}
            </div>
          </div>
          <span class="member-count">{{ group.memberCount }} member{{ group.memberCount > 1 ? 's' : '' }}</span>
        </div>

        <!-- Stats -->
        <div class="group-stats">
          <span class="stat">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
            </svg>
            {{ group.songCount }} songs
          </span>
          <span class="stat unlistened" *ngIf="getUnlistenedCount() > 0">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
            {{ getUnlistenedCount() }} unlistened
          </span>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="header-actions">
        <button class="action-btn primary" (click)="openAddSongModal()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"/>
            <line x1="5" y1="12" x2="19" y2="12"/>
          </svg>
          Add Song
        </button>
        <button class="action-btn secondary" (click)="openAddMemberModal()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
          </svg>
          Add Member
        </button>
        <button class="action-btn danger" (click)="leaveGroup()" *ngIf="!isAdmin()">
          Leave
        </button>
        <button class="refresh-btn" (click)="refresh()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M23 4v6h-6"/>
            <path d="M1 20v-6h6"/>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
          </svg>
        </button>
      </div>
    </header>

    <!-- Batch Actions Bar -->
    <div class="batch-actions" *ngIf="group.songs.length > 0">
      <button
        class="batch-btn"
        [disabled]="addingAllToQueue || getUnlistenedCount() === 0"
        (click)="addAllUnlistenedToQueue()"
      >
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
          <line x1="12" y1="8" x2="12" y2="16"/>
          <line x1="8" y1="12" x2="16" y2="12"/>
        </svg>
        <span *ngIf="!addingAllToQueue">Add {{ getUnlistenedCount() }} unlistened to Spotify queue</span>
        <span *ngIf="addingAllToQueue">Adding songs...</span>
      </button>
      <button
        class="batch-btn secondary"
        [disabled]="markingAllListened || getUnlistenedCount() === 0"
        (click)="markAllAsListened()"
      >
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
          <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
        </svg>
        <span *ngIf="!markingAllListened">Mark all listened</span>
        <span *ngIf="markingAllListened">Marking...</span>
      </button>
    </div>

    <!-- Filter Tabs -->
    <div class="filter-section" *ngIf="group.songs.length > 0">
      <div class="filter-tabs">
        <button
          class="filter-tab"
          [class.active]="songFilter === 'all'"
          (click)="setSongFilter('all')"
        >
          All
          <span class="count">{{ group.songs.length }}</span>
        </button>
        <button
          class="filter-tab"
          [class.active]="songFilter === 'unlistened'"
          (click)="setSongFilter('unlistened')"
        >
          Unlistened
          <span class="count">{{ getUnlistenedCount() }}</span>
        </button>
        <button
          class="filter-tab"
          [class.active]="songFilter === 'listened'"
          (click)="setSongFilter('listened')"
        >
          Listened
        </button>
        <button
          class="filter-tab"
          [class.active]="songFilter === 'queued'"
          (click)="setSongFilter('queued')"
        >
          Queued
        </button>
      </div>

      <!-- Search -->
      <div class="search-container">
        <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <line x1="21" y1="21" x2="16.65" y2="16.65"/>
        </svg>
        <input
          type="text"
          class="search-input"
          placeholder="Search songs..."
          [(ngModel)]="searchQuery"
          (input)="onSearchChange()"
        />
        <button class="clear-btn" *ngIf="searchQuery" (click)="clearSearch()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Songs List -->
    <div class="songs-list" *ngIf="filteredSongs.length > 0">
      <div
        class="song-card"
        *ngFor="let song of filteredSongs"
        [class.listened]="song.userStatus?.listened"
        [class.queued]="song.userStatus?.addedToQueue"
        (click)="openSongDetail(song)"
      >
        <!-- Album Art -->
        <div class="song-image">
          <img [src]="getAlbumArt(song)" [alt]="song.track.name" />
          <button class="play-overlay" (click)="playSong(song, $event)">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8 5v14l11-7z"/>
            </svg>
          </button>
        </div>

        <!-- Song Info -->
        <div class="song-info">
          <h4 class="song-name">{{ song.track.name }}</h4>
          <p class="song-artist">{{ getArtistNames(song) }}</p>
          <div class="song-meta">
            <span class="added-by">
              <img [src]="song.addedByAvatar || getDefaultAvatar()" class="adder-avatar" />
              {{ song.addedByName || song.addedBy }}
            </span>
            <span class="added-at">{{ formatDate(song.addedAt) }}</span>
          </div>
        </div>

        <!-- Status Indicators -->
        <div class="status-indicators">
          <span class="status-badge queued" *ngIf="song.userStatus?.addedToQueue" title="Added to queue">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
              <rect x="3" y="3" width="18" height="18" rx="2"/>
            </svg>
          </span>
          <span class="status-badge listened" *ngIf="song.userStatus?.listened" title="Listened">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
              <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
            </svg>
          </span>
        </div>

        <!-- Song Actions -->
        <div class="song-actions">
          <button
            class="action-btn"
            [class.active]="isInPlaylistBuilder(song.trackId)"
            (click)="addToPlaylistBuilder(song, $event)"
            title="Add to Playlist Builder"
          >
            <svg *ngIf="!isInPlaylistBuilder(song.trackId)" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"/>
              <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            <svg *ngIf="isInPlaylistBuilder(song.trackId)" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
            </svg>
          </button>
          <button
            class="action-btn queue"
            (click)="addToSpotifyQueue(song, $event)"
            [disabled]="actionLoading[song.id]"
            title="Add to Spotify Queue"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <line x1="12" y1="8" x2="12" y2="16"/>
              <line x1="8" y1="12" x2="16" y2="12"/>
            </svg>
          </button>
          <button
            class="action-btn listen"
            *ngIf="!song.userStatus?.listened"
            (click)="markAsListened(song, $event)"
            [disabled]="actionLoading[song.id]"
            title="Mark as listened"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
          </button>
          <button
            class="action-btn unlisten"
            *ngIf="song.userStatus?.listened"
            (click)="markAsUnlistened(song, $event)"
            [disabled]="actionLoading[song.id]"
            title="Mark as unlistened"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
          <button
            class="action-btn remove"
            *ngIf="canRemoveSong(song)"
            (click)="removeSong(song, $event)"
            [disabled]="actionLoading[song.id]"
            title="Remove song"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 6h18"/>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Empty States -->
    <div class="empty-state" *ngIf="group.songs.length === 0">
      <div class="empty-icon">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
        </svg>
      </div>
      <h3>No Songs Yet</h3>
      <p>Be the first to share a song with the group!</p>
      <button class="add-song-btn" (click)="openAddSongModal()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"/>
          <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        Add Song
      </button>
    </div>

    <div class="no-results" *ngIf="group.songs.length > 0 && filteredSongs.length === 0">
      <p>No songs match your filters</p>
      <button class="clear-filters-btn" (click)="songFilter = 'all'; searchQuery = ''; filterSongs()">
        Clear Filters
      </button>
    </div>
  </div>
</div>

<!-- Add Song Modal -->
<app-add-song-modal
  *ngIf="showAddSongModal"
  [groupId]="groupId"
  (songAdded)="onSongAdded($event)"
  (closed)="closeAddSongModal()"
></app-add-song-modal>

<!-- Add Member Modal -->
<app-add-member-modal
  *ngIf="showAddMemberModal"
  [groupId]="groupId"
  [existingMemberEmails]="getExistingMemberEmails()"
  (memberAdded)="onMemberAdded($event)"
  (closed)="closeAddMemberModal()"
></app-add-member-modal>

<!-- Song Detail Modal -->
<app-song-detail-modal #songDetailModal></app-song-detail-modal>
