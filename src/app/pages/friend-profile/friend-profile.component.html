<div class="page-container">
  <app-loader [loading]="loading" message="Loading profile..."></app-loader>

  <!-- Error State -->
  <div class="error-state" *ngIf="error && !loading">
    <div class="error-icon">
      <svg
        width="64"
        height="64"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"
      >
        <circle cx="12" cy="12" r="10" />
        <line x1="12" y1="8" x2="12" y2="12" />
        <line x1="12" y1="16" x2="12.01" y2="16" />
      </svg>
    </div>
    <h3>{{ error }}</h3>
    <button class="btn-outline" (click)="goBack()">Go Back</button>
  </div>

  <!-- Profile Content -->
  <div class="profile-content" *ngIf="profile && !loading && !error">
    <!-- Header -->
    <header class="profile-header">
      <button class="back-btn" (click)="goBack()">
        <svg
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="M15 18l-6-6 6-6" />
        </svg>
        Back to Friends
      </button>

      <div class="profile-info">
        <div class="profile-avatar">
          <img
            [src]="profile.avatar || 'assets/img/default-avatar.png'"
            [alt]="profile.displayName"
            (error)="$any($event.target).src = 'assets/img/default-avatar.png'"
          />
        </div>
        <div class="profile-details">
          <h1 class="profile-name">{{ profile.displayName }}</h1>
          <p class="profile-email">{{ profile.email }}</p>

          <!-- Friend Status Actions -->
          <div class="friend-actions">
            <!-- Friends - shows "Friends", hovers to "Remove Friend" -->
            <button
              *ngIf="isFriend"
              class="friend-status-btn is-friend"
              (click)="removeFriend()"
              [disabled]="actionLoading"
            >
              <span class="default-text">âœ“ Friends</span>
              <span class="hover-text">Remove Friend</span>
            </button>

            <!-- Outgoing Request - shows "Requested", hovers to "Cancel Request" -->
            <button
              *ngIf="isOutgoingRequest"
              class="friend-status-btn is-outgoing"
              (click)="cancelFriendRequest()"
              [disabled]="actionLoading"
            >
              <span class="default-text">Requested</span>
              <span class="hover-text">Cancel Request</span>
            </button>

            <!-- Incoming Request - shows Accept/Reject buttons -->
            <div *ngIf="isIncomingRequest" class="action-buttons">
              <button
                class="accept"
                (click)="acceptFriendRequest()"
                [disabled]="actionLoading"
              >
                Accept
              </button>
              <button
                class="reject"
                (click)="rejectFriendRequest()"
                [disabled]="actionLoading"
              >
                Reject
              </button>
            </div>

            <!-- Not Friends - shows "Add Friend" -->
            <button
              *ngIf="!isFriend && !isOutgoingRequest && !isIncomingRequest"
              class="friend-status-btn add-friend"
              (click)="sendFriendRequest()"
              [disabled]="actionLoading"
            >
              Add Friend
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Tab Navigation -->
    <div class="tabs-container">
      <div class="tabs-nav">
        <button
          class="tab-btn"
          [class.active]="activeTab === 'songs'"
          (click)="switchTab('songs')"
        >
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M9 18V5l12-2v13" />
            <circle cx="6" cy="18" r="3" />
            <circle cx="18" cy="16" r="3" />
          </svg>
          Top Songs
        </button>
        <button
          class="tab-btn"
          [class.active]="activeTab === 'artists'"
          (click)="switchTab('artists')"
        >
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
            <circle cx="12" cy="7" r="4" />
          </svg>
          Top Artists
        </button>
        <button
          class="tab-btn"
          [class.active]="activeTab === 'genres'"
          (click)="switchTab('genres')"
        >
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <polygon points="12 2 2 7 12 12 22 7 12 2" />
            <polyline points="2 17 12 22 22 17" />
            <polyline points="2 12 12 17 22 12" />
          </svg>
          Top Genres
        </button>
      </div>

      <!-- Term Selector -->
      <div class="term-selector">
        <button
          class="term-btn"
          [class.active]="activeTerm === 'short_term'"
          (click)="switchTerm('short_term')"
        >
          {{ getTermLabel("short_term") }}
        </button>
        <button
          class="term-btn"
          [class.active]="activeTerm === 'medium_term'"
          (click)="switchTerm('medium_term')"
        >
          {{ getTermLabel("medium_term") }}
        </button>
        <button
          class="term-btn"
          [class.active]="activeTerm === 'long_term'"
          (click)="switchTerm('long_term')"
        >
          {{ getTermLabel("long_term") }}
        </button>
      </div>
    </div>

    <!-- Top Songs Tab -->
    <div class="tab-content" *ngIf="activeTab === 'songs'">
      <div class="tracks-list" *ngIf="getCurrentSongs().length > 0">
        <div
          class="track-item"
          *ngFor="let track of getCurrentSongs(); let i = index"
        >
          <span class="track-rank">{{ i + 1 }}</span>
          <div class="track-image">
            <img
              [src]="
                track.album?.images?.[0]?.url ||
                track.imageUrl ||
                getDefaultArtist()
              "
              [alt]="track.name"
              (error)="$any($event.target).src = getDefaultArtist()"
            />
            <button
              class="play-overlay"
              (click)="playSong(track, $event)"
              title="Play this song now"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path d="M8 5v14l11-7z" />
              </svg>
            </button>
          </div>
          <div class="track-info">
            <h4 class="track-name">{{ track.name }}</h4>
            <p class="track-artist">
              <ng-container *ngIf="track.artists?.length; else artistName">
                <span
                  *ngFor="let artist of track.artists; let last = last"
                  (click)="goToArtist(artist.id, $event)"
                  class="artist-link"
                >
                  {{ artist.name }}{{ last ? "" : ", " }}
                </span>
              </ng-container>
              <ng-template #artistName>{{
                track.artistName || ""
              }}</ng-template>
            </p>
          </div>
          <span class="track-duration">{{
            formatDuration(track.duration_ms)
          }}</span>
          <div class="track-actions">
            <button
              class="action-btn"
              [class.in-queue]="isInQueue(track.id)"
              (click)="addToPlaylistBuilder(track, $event)"
              [title]="
                isInQueue(track.id)
                  ? 'Remove from Playlist Builder'
                  : 'Add to Playlist Builder - Build custom playlists'
              "
            >
              <svg
                *ngIf="!isInQueue(track.id)"
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <line x1="12" y1="5" x2="12" y2="19" />
                <line x1="5" y1="12" x2="19" y2="12" />
              </svg>
              <svg
                *ngIf="isInQueue(track.id)"
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <polyline points="20 6 9 17 4 12" />
              </svg>
            </button>
            <button
              class="action-btn"
              (click)="addToSpotifyQueue(track, $event)"
              title="Add to Spotify Queue - Song will play next in your Spotify app"
            >
              <svg
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                <line x1="12" y1="8" x2="12" y2="16" />
                <line x1="8" y1="12" x2="16" y2="12" />
              </svg>
            </button>
            <button
              class="action-btn"
              (click)="
                openInSpotify(
                  track.external_urls?.spotify || track.spotifyUrl,
                  $event
                )
              "
              title="Open in Spotify - View this song in your Spotify app"
            >
              <svg
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path
                  d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"
                />
              </svg>
            </button>
          </div>
        </div>
      </div>

      <div class="empty-state" *ngIf="getCurrentSongs().length === 0">
        <div class="empty-icon">
          <svg
            width="48"
            height="48"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
          >
            <path d="M9 18V5l12-2v13" />
            <circle cx="6" cy="18" r="3" />
            <circle cx="18" cy="16" r="3" />
          </svg>
        </div>
        <h3>No tracks available</h3>
        <p>
          {{ profile.displayName }}'s top tracks aren't available for this time
          period
        </p>
      </div>
    </div>

    <!-- Top Artists Tab -->
    <div class="tab-content" *ngIf="activeTab === 'artists'">
      <div class="artists-grid" *ngIf="getCurrentArtists().length > 0">
        <div
          class="artist-card"
          *ngFor="let artist of getCurrentArtists(); let i = index"
          (click)="goToArtist(artist.id)"
        >
          <span class="artist-rank">{{ i + 1 }}</span>
          <div class="artist-image-wrapper">
            <img
              [src]="
                artist.images?.[0]?.url || artist.imageUrl || getDefaultArtist()
              "
              [alt]="artist.name"
              (error)="$any($event.target).src = getDefaultArtist()"
            />
            <div class="image-overlay">
              <svg
                width="32"
                height="32"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path d="M8 5v14l11-7z" />
              </svg>
            </div>
          </div>
          <div class="artist-info">
            <h4 class="artist-name">{{ artist.name }}</h4>
            <p class="artist-meta" *ngIf="artist.followers?.total">
              {{ formatNumber(artist.followers.total) }} followers
            </p>
            <div class="artist-genres" *ngIf="artist.genres?.length">
              <span
                class="genre-tag"
                *ngFor="let genre of artist.genres.slice(0, 2)"
              >
                {{ genre }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <div class="empty-state" *ngIf="getCurrentArtists().length === 0">
        <div class="empty-icon">
          <svg
            width="48"
            height="48"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
          >
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
            <circle cx="12" cy="7" r="4" />
          </svg>
        </div>
        <h3>No artists available</h3>
        <p>
          {{ profile.displayName }}'s top artists aren't available for this time
          period
        </p>
      </div>
    </div>

    <!-- Top Genres Tab -->
    <div class="tab-content" *ngIf="activeTab === 'genres'">
      <div class="genres-list" *ngIf="getCurrentGenres().length > 0">
        <div
          class="genre-item"
          *ngFor="let genre of getCurrentGenres(); let i = index"
        >
          <span class="genre-rank">{{ i + 1 }}</span>
          <div class="genre-info">
            <h4 class="genre-name">{{ getGenreName(genre) }}</h4>
            <div class="genre-bar" *ngIf="getGenrePercentage(genre, i)">
              <div
                class="genre-fill"
                [style.width.%]="getGenrePercentage(genre, i)"
              ></div>
            </div>
          </div>
          <span class="genre-percentage" *ngIf="getGenrePercentage(genre, i)"
            >{{ getGenrePercentage(genre, i) | number: "1.0-0" }}%</span
          >
        </div>
      </div>

      <div class="empty-state" *ngIf="getCurrentGenres().length === 0">
        <div class="empty-icon">
          <svg
            width="48"
            height="48"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
          >
            <polygon points="12 2 2 7 12 12 22 7 12 2" />
            <polyline points="2 17 12 22 22 17" />
            <polyline points="2 12 12 17 22 12" />
          </svg>
        </div>
        <h3>No genres available</h3>
        <p>
          {{ profile.displayName }}'s top genres aren't available for this time
          period
        </p>
      </div>
    </div>
  </div>
</div>
