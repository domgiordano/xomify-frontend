<div class="page-container">
  <app-loader [loading]="loading" message="Loading friends..."></app-loader>

  <div class="friends-content" *ngIf="!loading">
    <!-- Page Header -->
    <header class="page-header">
      <div class="header-top">
        <div>
          <h1 class="page-title">Friends</h1>
          <p class="page-subtitle">Connect with other Xomify users</p>
        </div>
        <button class="refresh-btn" (click)="refresh()" title="Refresh">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M23 4v6h-6M1 20v-6h6" />
            <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15" />
          </svg>
        </button>
      </div>

      <!-- Tab Navigation -->
      <div class="tabs-nav">
        <button
          class="tab-btn"
          [class.active]="activeTab === 'friends'"
          (click)="switchTab('friends')"
        >
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
            <circle cx="9" cy="7" r="4" />
            <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
            <path d="M16 3.13a4 4 0 0 1 0 7.75" />
          </svg>
          Friends
          <span class="badge" *ngIf="friends.length > 0">{{ friends.length }}</span>
        </button>
        <button
          class="tab-btn"
          [class.active]="activeTab === 'pending'"
          (click)="switchTab('pending')"
        >
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10" />
            <polyline points="12 6 12 12 16 14" />
          </svg>
          Pending
          <span class="badge pending" *ngIf="getPendingCount() > 0">{{ getPendingCount() }}</span>
        </button>
        <button
          class="tab-btn"
          [class.active]="activeTab === 'search'"
          (click)="switchTab('search')"
        >
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8" />
            <path d="m21 21-4.35-4.35" />
          </svg>
          Find Friends
        </button>
      </div>
    </header>

    <!-- Friends List Tab -->
    <div class="tab-content" *ngIf="activeTab === 'friends'">
      <!-- Search friends -->
      <div class="search-box" *ngIf="friends.length > 0">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8" />
          <path d="m21 21-4.35-4.35" />
        </svg>
        <input
          type="text"
          placeholder="Search your friends..."
          [(ngModel)]="friendsSearchQuery"
          (input)="filterFriends()"
        />
        <button class="clear-btn" *ngIf="friendsSearchQuery" (click)="clearFriendsSearch()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg>
        </button>
      </div>

      <!-- Stats -->
      <div class="stats-bar" *ngIf="friends.length > 0">
        <span class="count">
          <strong>{{ filteredFriends.length }}</strong>
          {{ filteredFriends.length === 1 ? 'friend' : 'friends' }}
          <span *ngIf="friendsSearchQuery"> matching "{{ friendsSearchQuery }}"</span>
        </span>
      </div>

      <!-- Friends Grid -->
      <div class="users-grid" *ngIf="filteredFriends.length > 0">
        <div
          class="user-card"
          *ngFor="let friend of filteredFriends"
          (click)="goToProfile(friend)"
        >
          <div class="user-avatar">
            <img
              [src]="friend.avatar || getDefaultAvatar()"
              [alt]="friend.displayName"
              (error)="$any($event.target).src = getDefaultAvatar()"
            />
          </div>
          <div class="user-info">
            <h3 class="user-name">{{ friend.displayName }}</h3>
            <p class="user-email">{{ friend.email }}</p>
            <p class="mutual-count" *ngIf="friend.mutualCount">
              {{ friend.mutualCount }} mutual friend{{ friend.mutualCount === 1 ? '' : 's' }}
            </p>
          </div>
          <button
            class="action-btn remove"
            (click)="removeFriend(friend, $event)"
            [class.loading]="actionLoading[friend.email]"
            title="Remove friend"
          >
            <span *ngIf="!actionLoading[friend.email]">Friends</span>
            <span *ngIf="actionLoading[friend.email]">...</span>
          </button>
        </div>
      </div>

      <!-- Empty State -->
      <div class="empty-state" *ngIf="friends.length === 0">
        <div class="empty-icon">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
            <circle cx="9" cy="7" r="4" />
            <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
            <path d="M16 3.13a4 4 0 0 1 0 7.75" />
          </svg>
        </div>
        <h3>No friends yet</h3>
        <p>Find and add friends to see their music taste!</p>
        <button class="btn-primary" (click)="switchTab('search')">Find Friends</button>
      </div>

      <!-- No results -->
      <div class="empty-state" *ngIf="friends.length > 0 && filteredFriends.length === 0">
        <h3>No friends found</h3>
        <p>Try a different search term</p>
      </div>
    </div>

    <!-- Pending Requests Tab -->
    <div class="tab-content" *ngIf="activeTab === 'pending'">
      <!-- Incoming Requests -->
      <section class="requests-section" *ngIf="incomingRequests.length > 0">
        <h2 class="section-title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
            <circle cx="8.5" cy="7" r="4" />
            <polyline points="17 11 19 13 23 9" />
          </svg>
          Incoming Requests
          <span class="badge">{{ incomingRequests.length }}</span>
        </h2>
        <div class="users-list">
          <div class="user-card horizontal" *ngFor="let request of incomingRequests">
            <div class="user-avatar">
              <img
                [src]="request.avatar || getDefaultAvatar()"
                [alt]="request.displayName"
                (error)="$any($event.target).src = getDefaultAvatar()"
              />
            </div>
            <div class="user-info">
              <h3 class="user-name">{{ request.displayName }}</h3>
              <p class="user-email">{{ request.email }}</p>
              <p class="mutual-count" *ngIf="request.mutualCount">
                {{ request.mutualCount }} mutual friend{{ request.mutualCount === 1 ? '' : 's' }}
              </p>
            </div>
            <div class="action-buttons">
              <button
                class="action-btn accept"
                (click)="acceptRequest(request)"
                [class.loading]="actionLoading[request.email]"
              >
                {{ actionLoading[request.email] ? '...' : 'Accept' }}
              </button>
              <button
                class="action-btn reject"
                (click)="rejectRequest(request)"
                [class.loading]="actionLoading[request.email]"
              >
                {{ actionLoading[request.email] ? '...' : 'Reject' }}
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Outgoing Requests -->
      <section class="requests-section" *ngIf="outgoingRequests.length > 0">
        <h2 class="section-title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
            <circle cx="8.5" cy="7" r="4" />
            <line x1="20" y1="8" x2="20" y2="14" />
            <line x1="23" y1="11" x2="17" y2="11" />
          </svg>
          Sent Requests
          <span class="badge muted">{{ outgoingRequests.length }}</span>
        </h2>
        <div class="users-list">
          <div class="user-card horizontal" *ngFor="let request of outgoingRequests">
            <div class="user-avatar">
              <img
                [src]="request.avatar || getDefaultAvatar()"
                [alt]="request.displayName"
                (error)="$any($event.target).src = getDefaultAvatar()"
              />
            </div>
            <div class="user-info">
              <h3 class="user-name">{{ request.displayName }}</h3>
              <p class="user-email">{{ request.email }}</p>
            </div>
            <button
              class="action-btn cancel"
              (click)="cancelRequest(request)"
              [class.loading]="actionLoading[request.email]"
            >
              {{ actionLoading[request.email] ? '...' : 'Cancel' }}
            </button>
          </div>
        </div>
      </section>

      <!-- Empty State -->
      <div class="empty-state" *ngIf="incomingRequests.length === 0 && outgoingRequests.length === 0">
        <div class="empty-icon">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="12" cy="12" r="10" />
            <polyline points="12 6 12 12 16 14" />
          </svg>
        </div>
        <h3>No pending requests</h3>
        <p>Friend requests you send or receive will appear here</p>
      </div>
    </div>

    <!-- Find Friends Tab -->
    <div class="tab-content" *ngIf="activeTab === 'search'">
      <!-- Search Input -->
      <div class="search-box large">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8" />
          <path d="m21 21-4.35-4.35" />
        </svg>
        <input
          type="text"
          placeholder="Search by name or email..."
          [(ngModel)]="searchQuery"
          (input)="onSearchInput()"
          autofocus
        />
        <button class="clear-btn" *ngIf="searchQuery" (click)="clearSearch()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg>
        </button>
      </div>

      <p class="search-hint">Search for other Xomify users to add them as friends</p>

      <!-- Loading State -->
      <div class="search-loading" *ngIf="isSearching">
        <div class="spinner"></div>
        <span>Searching...</span>
      </div>

      <!-- Search Results -->
      <div class="users-list" *ngIf="searchResults.length > 0 && !isSearching">
        <div class="user-card horizontal" *ngFor="let result of searchResults">
          <div class="user-avatar">
            <img
              [src]="result.avatar || getDefaultAvatar()"
              [alt]="result.displayName"
              (error)="$any($event.target).src = getDefaultAvatar()"
            />
          </div>
          <div class="user-info">
            <h3 class="user-name">{{ result.displayName }}</h3>
            <p class="user-email">{{ result.email }}</p>
            <p class="mutual-count" *ngIf="result.mutualCount">
              {{ result.mutualCount }} mutual friend{{ result.mutualCount === 1 ? '' : 's' }}
            </p>
          </div>
          <button
            class="action-btn"
            [class.friend]="result.isFriend"
            [class.pending]="result.isPending && !result.isFriend"
            [class.add]="!result.isFriend && !result.isPending"
            [class.loading]="actionLoading[result.email]"
            (click)="!result.isFriend && !result.isPending && sendRequest(result)"
            [disabled]="result.isFriend || result.isPending"
          >
            <span *ngIf="result.isFriend">Friends</span>
            <span *ngIf="result.isPending && !result.isFriend">Pending</span>
            <span *ngIf="!result.isFriend && !result.isPending && !actionLoading[result.email]">Add Friend</span>
            <span *ngIf="actionLoading[result.email]">...</span>
          </button>
        </div>
      </div>

      <!-- No Results -->
      <div class="empty-state" *ngIf="hasSearched && searchResults.length === 0 && !isSearching">
        <div class="empty-icon">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="11" cy="11" r="8" />
            <path d="m21 21-4.35-4.35" />
          </svg>
        </div>
        <h3>No users found</h3>
        <p>Try searching with a different name or email</p>
      </div>

      <!-- Initial State -->
      <div class="empty-state subtle" *ngIf="!hasSearched && !isSearching">
        <div class="empty-icon">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
            <circle cx="8.5" cy="7" r="4" />
            <line x1="20" y1="8" x2="20" y2="14" />
            <line x1="23" y1="11" x2="17" y2="11" />
          </svg>
        </div>
        <h3>Find friends on Xomify</h3>
        <p>Search by their name or email address</p>
      </div>
    </div>
  </div>
</div>
