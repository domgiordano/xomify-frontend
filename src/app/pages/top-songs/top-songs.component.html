<div class="page-container">
  <div class="page-header">
    <h1 class="page-title">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
        <path
          d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"
        />
      </svg>
      Top Songs
    </h1>
    <p class="page-subtitle">Your most played tracks</p>
  </div>

  <!-- Time Range Selector -->
  <div class="time-range-selector">
    <button
      *ngFor="let range of timeRanges"
      class="range-btn"
      [class.active]="activeTimeRange === range.value"
      (click)="onTimeRangeChange(range.value)"
    >
      {{ range.label }}
    </button>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="loading">
    <div class="loader">
      <div class="wave"></div>
      <div class="wave"></div>
      <div class="wave"></div>
      <div class="wave"></div>
      <div class="wave"></div>
    </div>
    <p class="loading-text">Loading your top songs...</p>
  </div>

  <!-- Error State -->
  <div class="error-container" *ngIf="error && !loading">
    <svg
      width="48"
      height="48"
      viewBox="0 0 24 24"
      fill="none"
      stroke="#ff4757"
      stroke-width="2"
    >
      <circle cx="12" cy="12" r="10" />
      <line x1="12" y1="8" x2="12" y2="12" />
      <line x1="12" y1="16" x2="12.01" y2="16" />
    </svg>
    <p class="error-text">{{ error }}</p>
    <button class="retry-btn" (click)="loadTopSongs()">Try Again</button>
  </div>

  <!-- Songs Grid -->
  <div class="songs-grid" *ngIf="!loading && !error">
    <div class="song-card-wrapper" *ngFor="let song of topSongs; let i = index">
      <div
        class="song-card"
        [class.flipped]="song.flipped"
        (click)="flipCard(song, i)"
      >
        <!-- Card Front -->
        <div class="card-front">
          <div class="rank-badge">#{{ i + 1 }}</div>

          <div class="album-art">
            <img
              [src]="song.album?.images?.[1]?.url || song.album?.images?.[0]?.url || 'assets/default-album.png'"
              [alt]="song.name"
            />
            <div class="play-overlay">
              <svg class="play-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M8 5v14l11-7z" />
              </svg>
            </div>
            <span class="explicit-badge" *ngIf="song.explicit">E</span>
          </div>

          <div class="song-info">
            <div class="song-text">
              <h3 class="song-name">{{ song.name }}</h3>
              <p class="artist-names">{{ getArtistNames(song.artists) }}</p>
            </div>
            <button 
              class="add-queue-btn"
              [class.in-queue]="isInQueue(song.id)"
              (click)="toggleQueue(song, $event)"
              [title]="isInQueue(song.id) ? 'Remove from queue' : 'Add to queue'"
            >
              <svg
                *ngIf="!isInQueue(song.id)"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <line x1="12" y1="5" x2="12" y2="19" />
                <line x1="5" y1="12" x2="19" y2="12" />
              </svg>
              <svg
                *ngIf="isInQueue(song.id)"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
              </svg>
            </button>
          </div>

          <div class="flip-hint">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M17 1l4 4-4 4" />
              <path d="M3 11V9a4 4 0 0 1 4-4h14" />
              <path d="M7 23l-4-4 4-4" />
              <path d="M21 13v2a4 4 0 0 1-4 4H3" />
            </svg>
            <span>Tap for stats</span>
          </div>
        </div>

        <!-- Card Back - click anywhere to flip back -->
        <div class="card-back">
          <div class="back-header">
            <span class="back-rank">#{{ i + 1 }}</span>
          </div>

          <h3 class="back-title">{{ song.name }}</h3>

          <!-- Artists Section -->
          <div class="stats-section artists-section">
            <span class="section-label">Artists</span>
            <div class="artists-list">
              <a
                *ngFor="let artist of song.artists"
                class="artist-link"
                (click)="goToArtist(artist.id, $event)"
              >
                <svg
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                >
                  <path
                    d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"
                  />
                </svg>
                {{ artist.name }}
              </a>
            </div>
          </div>

          <!-- Album Section -->
          <div class="stats-section">
            <span class="section-label">Album</span>
            <a class="album-link" (click)="goToAlbum(song.album.id, $event)">
              <svg
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path
                  d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 14.5c-2.49 0-4.5-2.01-4.5-4.5S9.51 7.5 12 7.5s4.5 2.01 4.5 4.5-2.01 4.5-4.5 4.5zm0-5.5c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"
                />
              </svg>
              {{ song.album.name }}
            </a>
            <span class="album-year">{{
              formatReleaseYear(song.album.release_date)
            }}</span>
          </div>

          <!-- Stats Grid -->
          <div class="stats-grid">
            <div class="stat-item">
              <span class="stat-value">{{
                formatDuration(song.duration_ms)
              }}</span>
              <span class="stat-label">Duration</span>
            </div>
            <div class="stat-item">
              <span class="stat-value">{{ song.popularity }}%</span>
              <span class="stat-label">{{
                getPopularityLabel(song.popularity)
              }}</span>
            </div>
          </div>

          <!-- Popularity Bar -->
          <div class="popularity-bar-container">
            <div class="popularity-bar">
              <div
                class="popularity-fill"
                [style.width.%]="song.popularity"
              ></div>
            </div>
          </div>

          <!-- Open in Spotify Button -->
          <button
            class="spotify-link-btn"
            (click)="openInSpotify(song.external_urls.spotify, $event)"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path
                d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"
              />
            </svg>
            Open in Spotify
          </button>

          <!-- Flip back hint -->
          <div class="flip-hint back">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M17 1l4 4-4 4" />
              <path d="M3 11V9a4 4 0 0 1 4-4h14" />
            </svg>
            <span>Tap to flip back</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="!loading && !error && topSongs.length === 0">
    <svg
      width="64"
      height="64"
      viewBox="0 0 24 24"
      fill="none"
      stroke="#8a8a9a"
      stroke-width="1.5"
    >
      <path
        d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"
      />
    </svg>
    <h3>No Top Songs Yet</h3>
    <p>Keep listening to build up your top tracks!</p>
  </div>
</div>
