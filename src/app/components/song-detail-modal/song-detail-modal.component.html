<div class="modal-backdrop" *ngIf="isVisible" (click)="onBackdropClick($event)">
  <div class="modal-content" *ngIf="track">
    <!-- Close button -->
    <button class="close-btn" (click)="close()">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"/>
        <line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </button>

    <!-- Album art and basic info -->
    <div class="track-header">
      <div class="album-art-container">
        <img [src]="getAlbumArt()" [alt]="track.name" class="album-art" />
        <button class="play-overlay-btn" (click)="togglePlay()">
          <svg *ngIf="!isPlaying" width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
            <path d="M8 5v14l11-7z"/>
          </svg>
          <svg *ngIf="isPlaying" width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
            <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
          </svg>
        </button>
        <span class="explicit-badge" *ngIf="track.explicit">E</span>
      </div>

      <div class="track-info">
        <h2 class="track-name">{{ track.name }}</h2>
        <div class="artists-list">
          <span
            *ngFor="let artist of track.artists; let last = last"
            class="artist-link"
            (click)="goToArtist(artist.id)"
          >
            {{ artist.name }}<span *ngIf="!last">, </span>
          </span>
        </div>
        <div class="album-info" (click)="goToAlbum()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 14.5c-2.49 0-4.5-2.01-4.5-4.5S9.51 7.5 12 7.5s4.5 2.01 4.5 4.5-2.01 4.5-4.5 4.5zm0-5.5c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"/>
          </svg>
          <span>{{ track.album.name }}</span>
          <span class="album-year" *ngIf="formatReleaseYear()">{{ formatReleaseYear() }}</span>
        </div>
        <div class="track-meta" *ngIf="track.duration_ms">
          <span class="duration">{{ formatDuration(track.duration_ms) }}</span>
          <span class="popularity" *ngIf="track.popularity">{{ track.popularity }}% popularity</span>
        </div>
      </div>
    </div>

    <!-- Rating section -->
    <div class="rating-section">
      <h3 class="section-title">Your Rating</h3>
      <div class="rating-container">
        <app-star-rating
          [rating]="userRating"
          [readonly]="savingRating"
          size="large"
          (ratingChange)="onRatingChange($event)"
        ></app-star-rating>
        <button
          class="remove-rating-btn"
          *ngIf="userRating > 0"
          (click)="removeRating()"
          [disabled]="savingRating"
        >
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
          Remove
        </button>
      </div>
    </div>

    <!-- Friends ratings section -->
    <div class="friends-ratings-section" *ngIf="friendsRatings.length > 0 || loadingFriendsRatings">
      <h3 class="section-title">Friends' Ratings</h3>
      <div class="loading-friends" *ngIf="loadingFriendsRatings">
        <div class="mini-loader"></div>
        <span>Loading friends' ratings...</span>
      </div>
      <div class="friends-ratings-list" *ngIf="!loadingFriendsRatings">
        <div
          class="friend-rating-item"
          *ngFor="let friend of friendsRatings"
          (click)="goToFriendProfile(friend.email)"
        >
          <img
            [src]="friend.avatar || getDefaultAvatar()"
            [alt]="friend.displayName"
            class="friend-avatar"
          />
          <span class="friend-name">{{ friend.displayName || friend.email }}</span>
          <app-star-rating
            [rating]="friend.rating"
            [readonly]="true"
            size="small"
          ></app-star-rating>
        </div>
      </div>
    </div>

    <!-- Action buttons -->
    <div class="action-buttons">
      <button class="action-btn" [class.active]="isInQueue()" (click)="addToQueue()">
        <svg *ngIf="!isInQueue()" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"/>
          <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        <svg *ngIf="isInQueue()" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
          <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
        </svg>
        <span>{{ isInQueue() ? 'In Playlist' : 'Add to Playlist' }}</span>
      </button>
      <button class="action-btn" (click)="addToSpotifyQueue()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
          <line x1="12" y1="8" x2="12" y2="16"/>
          <line x1="8" y1="12" x2="16" y2="12"/>
        </svg>
        <span>Spotify Queue</span>
      </button>
      <button class="action-btn spotify-btn" (click)="openInSpotify()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/>
        </svg>
        <span>Open in Spotify</span>
      </button>
    </div>
  </div>
</div>
